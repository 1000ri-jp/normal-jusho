# Monthly data update workflow
#
# Downloads the latest government address data, regenerates dictionary files,
# runs tests, and creates a PR with the updated data.
#
# Schedule: 1st of every month at 00:00 UTC (09:00 JST)
# Manual trigger: workflow_dispatch

name: Monthly Data Update

on:
  schedule:
    # Run at 00:00 UTC on the 1st of every month (09:00 JST)
    - cron: '0 0 1 * *'
  workflow_dispatch:
    inputs:
      skip_mlit:
        description: 'Skip MLIT data download (use existing kokudo data)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # MLIT download + tree generation can take a while

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pip install poetry

      - name: Install dependencies
        working-directory: backend
        run: |
          poetry config virtualenvs.create false
          poetry install --no-interaction --no-ansi -E all

      - name: Download latest source data
        working-directory: backend
        run: python ../scripts/download_sources.py --output-dir data/
        env:
          SKIP_MLIT: ${{ github.event.inputs.skip_mlit || 'false' }}

      - name: Generate KEN_ALL dictionary files
        working-directory: backend
        run: |
          echo "=== Generating kenall tree files ==="
          python -c "
          from address_kokudo_kenall.create_tree_file_kenall import create_trees
          create_trees('data/')
          print('kenall tree files generated successfully.')
          "

      - name: Generate KOKUDO dictionary files
        if: ${{ github.event.inputs.skip_mlit != 'true' }}
        working-directory: backend
        run: |
          echo "=== Generating kokudo tree files ==="
          python -c "
          from address_kokudo_kenall.create_tree_file_kokudo import create_trees
          create_trees('data/')
          print('kokudo tree files generated successfully.')
          "

      - name: Verify generated data files
        working-directory: backend
        run: |
          echo "=== Verifying data files ==="
          for f in data/kenall_tree.json data/kenall_city_tree.json data/kenall_building_dict.json data/jigyosyo_dict.json data/kenall_df.csv; do
            if [ -f "$f" ]; then
              size=$(stat -c%s "$f" 2>/dev/null || stat -f%z "$f" 2>/dev/null)
              echo "OK: $f (${size} bytes)"
            else
              echo "MISSING: $f"
              exit 1
            fi
          done

          # Also check kokudo files if not skipped
          if [ "${{ github.event.inputs.skip_mlit }}" != "true" ]; then
            for f in data/kokudo_tree.json data/kokudo_city_tree.json data/kokudo_df.csv; do
              if [ -f "$f" ]; then
                size=$(stat -c%s "$f" 2>/dev/null || stat -f%z "$f" 2>/dev/null)
                echo "OK: $f (${size} bytes)"
              else
                echo "MISSING: $f"
                exit 1
              fi
            done
          fi

      - name: Run tests
        working-directory: backend
        run: |
          echo "=== Running test suite ==="
          python -m pytest tests/ -v --tb=short -x
        env:
          ADDRESS_DATA_FOLDER: data/

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "data: update address dictionary data (${{ steps.date.outputs.date }})"
          title: "Data Update: ${{ steps.date.outputs.date }}"
          body: |
            ## Automated Data Update

            This PR updates the address dictionary data files from the latest government sources.

            **Date**: ${{ steps.date.outputs.date }}

            **Updated data sources**:
            - KEN_ALL (Japan Post postal code data)
            - Jigyosyo (business office postal codes)
            - Tatemono (large building postal codes)
            ${{ github.event.inputs.skip_mlit != 'true' && '- KOKUDO (MLIT address data with coordinates)' || '- KOKUDO: skipped (using existing data)' }}

            **Verification**:
            - [x] Data files generated successfully
            - [x] All tests passed

            ---
            *This PR was created automatically by the monthly data update workflow.*
          branch: data-update/${{ steps.date.outputs.date }}
          delete-branch: true
          labels: |
            data-update
            automated

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Data update failed: ${new Date().toISOString().split('T')[0]}`,
              body: [
                '## Data Update Failure',
                '',
                `**Workflow run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                `**Date**: ${new Date().toISOString().split('T')[0]}`,
                '',
                'The monthly data update workflow failed. Please check the workflow logs for details.',
                '',
                'Common causes:',
                '- Government data source URL changed',
                '- Data format changed',
                '- Test failures due to address changes',
                '',
                '---',
                '*This issue was created automatically.*',
              ].join('\n'),
              labels: ['bug', 'data-update'],
            });
            console.log(`Created issue #${issue.data.number}`);
